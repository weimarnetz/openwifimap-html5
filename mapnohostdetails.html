<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OpenWiFiMap</title>

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.css" />
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.ie.css" />
    <![endif]-->
    <script src="http://cdn.leafletjs.com/leaflet-0.6.2/leaflet.js"></script>
    <link rel="stylesheet" href="http://leaflet.github.com/Leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="http://leaflet.github.com/Leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <!--[if lte IE 8]><link rel="stylesheet" href="http://leaflet.github.com/Leaflet.markercluster/dist/MarkerCluster.Default.ie.css" /><![endif]-->
    <script src="http://leaflet.github.com/Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
    <script src="external/leaflet/Bing.js"></script>
    <!--leaflet end-->

    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>

    <script src="external/icanhaz/ICanHaz.js"></script>

    <script src="http://andrenarchy.github.io/couchmap/script/couchmap.js"></script>

    <link rel="stylesheet" href="style/owm_widget.css" />
    <script src="script/owm_widget.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><!--target-densitydpi=device-dpi-->
  </head>
  <body style="margin: 0; margin: 0;">
    <script id="mappopupmust" type="text/html">
	<div class="" style="padding: 20px 20px; width: 222px;">
	  <div class="ui-bar ui-bar-a ui-corner-all">
	    <h3>
	      {{hostname}}
	    </h3>
	  </div>
	  <div class="ui-body ui-body-a ui-corner-all">
	    <p>Wer? {{freifunk.contact.nickname}}</p>
	  </div>
	</div>
    </script>
    <div id="map" style="width: 100%; height: 100%;"></div>
    <script>
      function getPopupHTML(nodedata) {
        return ich.mappopupmust(nodedata, true);
      }

      $(document).ready(function() {
        var owmwidget = new OWMWidget(
          {
            getPopupHTML: getPopupHTML,
            onBboxChange: function(bbox) {
              window.location.hash = 'bbox='+bbox.toString();
            }
          },
          {},
          {
            couchUrl: 'http://mapapi.weimarnetz.de/',
            coarseThreshold: 500
          }
        );

        function onResize() {
          $("#map").height( $(window).height() );
          owmwidget.map.invalidateSize();
        }

        $(window).resize( onResize );
        onResize();

        // determine bounding box from hash
        var hash = window.location.hash;
        var bbox = null;
        if (hash.search(/#bbox=/)!=-1) {
          bbox = getBboxFromString(hash.replace(/#bbox=/, ""));
        }

        // set location
        if (bbox) {
          owmwidget.fitBbox(bbox);
        } else {
          owmwidget.map.locate({setView: true, maxZoom: 15})
            .on('locationerror', function(e) {console.log(e.message)});
        }
      });
    </script>
  </body>
</html>

